<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>League Table</title>
    <style>
        body {
            font-family: Arial,Helvetica,sans-serif;
        }

        h2 {
            margin-left: 60px;
        }
        div.frame {
            /*width: 30%;*/
            height: 300px;
            padding: 0 30px;
            margin: 0 60px 0 30px;
            /*border: 2px solid lightslategray;*/
            float: left;
        }

        div#table table {
            border: 1px solid gray;
            border-collapse: collapse;
        }
        div#table table th, div#table table td {
            border: 1px solid gray;
            padding: 5px;
            min-width: 5em;
        }
    </style>
</head>
<body>

<h2>League Table Calculator</h2>
<div id="input" class="frame">
    <h3>Match Results</h3>
    <textarea id="resultInput" cols="50" rows="15" placeholder="Home Team, Home Goals, Away Team, Away Goals"></textarea>
    <p><button id="enter">Enter</button></p>
    <p><label>Sort by name<input id="alpha" type="checkbox"></label></p>
</div>


<div id="output" class="frame">
    <h3>League Table</h3>
    <div id="table"></div>
</div>

<script src="lib/lodash.js"></script>

<script>
    'use strict';
    Function.prototype.memoize = function(resolverFn) {
        return _.memoize(this, resolverFn);
    };

    var resultData = [];

    let leaguePositions = (results) =>_.sortBy(allTeamStats(results), (t) => -t.points );
    let teamsByName = (results) => _.sortBy(allTeamStats(results), (t) => t.name );

    let allTeamStats = (results) =>  teams(results).map( (t) => teamStats(results, t));

    let teams = ((results) => {
        let homeTeams = results.map( (r) => r.home.team);
        let awayTeams = results.map( (r) => r.away.team);
        return _.uniq(homeTeams.concat(awayTeams));
    }).memoize((r) => r.length);


    let teamResults = ((results, teamName) => results.filter( (r) => r.home.team == teamName || r.away.team == teamName) ).memoize((r, tn) => tn + r.length);

    let teamStats = ((results, teamName) => {
        let ourResults = teamResults(results, teamName);
        return {
            name: teamName,
            games: ourResults.length,
            won:   ourResults.filter((r) => won(teamName, r)).length,
            drawn:   ourResults.filter((r) => drawn(r)).length,
            lost:   ourResults.filter((r) => lost(teamName, r)).length,
            goalsFor:_.sum(ourResults.map((r) => goalsFor(teamName, r))),
            goalsAgainst:_.sum(ourResults.map((r) => goalsAgainst(teamName, r))),
            goalDifference:_.sum(ourResults.map((r) => goalsFor(teamName, r) - goalsAgainst(teamName, r))),
            points: _.sum(ourResults.map( (r) => pointsFor(teamName, r)))
        }
    }).memoize((r, tn) => tn + r.length);


    let goalsFor = (teamName, result) => teamName == result.home.team ? result.home.goals : result.away.goals;
    let goalsAgainst = (teamName, result) => teamName == result.home.team ? result.away.goals : result.home.goals;
    let drawn = (result) => result.home.goals == result.away.goals;
    let won = (teamName, result) => goalsFor(teamName, result) > goalsAgainst(teamName, result);
    let lost = (teamName, result) => goalsFor(teamName, result) < goalsAgainst(teamName, result);
    let pointsFor = (teamName, result) => won(teamName, result) ? 3 : drawn(result) ? 1 : 0;


</script>

<script>
    'use strict'
    function tableHtml(leaguePositions) {
        return '<table>' +
                '<thead>' +
                '<tr>' +
                '<th>Team</th>' +
                '<th>Games</th>' +
                '<th>Won</th>' +
                '<th>Drawn</th>' +
                '<th>Lost</th>' +
                '<th>Goals For</th>' +
                '<th>Goals Against</th>' +
                '<th>Goal Difference</th>' +
                '<th>Points</th>' +
                '</tr>' +
                '</thead>' +
                '<tbody>' +
                leaguePositions.map(function(r) { return rowHtml(r); }).join('') +
                '</tbody>' +
                '</table>'
    }

    function rowHtml(teamPosition) {
        return '<tr>' +
                '<td>' + teamPosition.name + '</td>' +
                '<td>' + teamPosition.games + '</td>' +
                '<td>' + teamPosition.won + '</td>' +
                '<td>' + teamPosition.drawn + '</td>' +
                '<td>' + teamPosition.lost + '</td>' +
                '<td>' + teamPosition.goalsFor + '</td>' +
                '<td>' + teamPosition.goalsAgainst + '</td>' +
                '<td>' + teamPosition.goalDifference + '</td>' +
                '<td>' + teamPosition.points + '</td>' +
                '</tr>'
    }

    function showLeagueTable() {
        let positions = document.getElementById('alpha').checked ? teamsByName(resultData) : leaguePositions(resultData);
        document.getElementById('table').innerHTML = tableHtml(positions);
    }

    showLeagueTable();
</script>

<script>
    'use strict';
    function enterResults() {
        let inputArea = document.getElementById('resultInput');
        resultData = resultData.concat(parseCsvResults(inputArea.value));
        inputArea.value = '';
        showLeagueTable();
    }

    function parseCsvResults(text) {
        return text.trim().split('\n').filter( (l) => l.trim() ).map(parseCsvLine);
    }

    function parseCsvLine(line) {
        let tokens = line.trim().split(/ *, */).map( (w) => w.trim() );
        return { home: {team: tokens[0], goals: parseInt(tokens[1])},  away: {team: tokens[2], goals: parseInt(tokens[3])} };
    }

    function initPage() {
        document.getElementById('enter').addEventListener('click', enterResults);
        document.getElementById('alpha').addEventListener('click', showLeagueTable);
    }

    initPage();
</script>

</body>
</html>